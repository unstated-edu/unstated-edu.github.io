<!doctype html>
<html>
  <head>
    <title>Receiver</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #ball {
        width: 80px;
        height: 80px;
        left: -100px;
        top: -100px;
        background: black;
        border-radius: 50%;
        position: absolute;
        transform: translate(-50%, -50%);
        transition:
          left 0.1s,
          top 0.1s;
      }
      #info {
        position: fixed;
        top: 20px;
        left: 20px;
        line-height: 2;
      }
    </style>
  </head>
  <body>
    <div id="info">Waiting...</div>
    <div id="ball"></div>

    <script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
    <script>
      var API_KEY = "biplaQ.iovzWA:ffx3oR9mKYBjDAfLiHlVJ4KWacO_9mEU6KOocxicrKY";

      var client = new Ably.Realtime(API_KEY);
      var channel = client.channels.get("motion");

      var ball = document.getElementById("ball");
      var info = document.getElementById("info");

      const decoder = new TextDecoder();

      // IMPORTANTE: non filtrare per "update"
      channel.subscribe(function (msg) {
        let text;

        // MQTT -> spesso binario
        if (msg.data instanceof Uint8Array) {
          text = decoder.decode(msg.data);
        } else if (msg.data instanceof ArrayBuffer) {
          text = decoder.decode(new Uint8Array(msg.data));
        } else {
          text = String(msg.data);
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.log("Not JSON:", text);
          return;
        }

        info.innerHTML =
          "alpha: " +
          data.alpha +
          "<br>" +
          "beta: " +
          data.beta +
          "<br>" +
          "gamma: " +
          data.gamma;

        var x = map(data.gamma, -90, 90, 0, window.innerWidth);
        var y = map(data.beta, -90, 90, 0, window.innerHeight);

        ball.style.left = x + "px";
        ball.style.top = y + "px";
      });

      function map(value, inMin, inMax, outMin, outMax) {
        return ((value - inMin) * (outMax - outMin)) / (inMax - inMin) + outMin;
      }
    </script>
  </body>
</html>
