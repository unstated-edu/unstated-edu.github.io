<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Person Body Tracking Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
            background: #f0f0f0;
        }
        
        h1 {
            color: #333;
        }
        
        #container {
            position: relative;
            display: inline-block;
            margin: 20px auto;
        }
        
        video {
            border: 3px solid #333;
            border-radius: 8px;
            max-width: 100%;
            display: block;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border: 3px solid #333;
            border-radius: 8px;
            max-width: 100%;
            display: block;
        }
        
        #status {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-size: 18px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        button:hover {
            background: #0b7dda;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #info {
            text-align: left;
            background: white;
            padding: 15px;
            margin: 20px auto;
            border-radius: 8px;
        }
        
        .person-info {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .keypoint-info {
            display: inline-block;
            margin: 3px 5px;
            padding: 3px 8px;
            background: #e3f2fd;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ðŸ•º Multi-Person Body Tracking Demo</h1>
    <p>Tracks multiple people with facial features! Each person gets a different color.</p>
    <p><small>Note: Video is not mirrored for better mobile compatibility</small></p>
    
    <div id="status">Loading model... Please wait</div>
    
    <button id="startBtn" disabled>Start Camera</button>
    
    <div id="container">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <div id="info">
        <strong>Detected People:</strong>
        <div id="keypointList">Waiting for pose detection...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>

    <script>
        // Get DOM elements
        const video = document.getElementById("webcam");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const status = document.getElementById("status");
        const startBtn = document.getElementById("startBtn");
        const keypointList = document.getElementById("keypointList");

        let model = null;
        let isDetecting = false;

        // Define body part connections for skeleton (including facial features)
        const connections = [
            // Face connections
            ["nose", "leftEye"],
            ["nose", "rightEye"],
            ["leftEye", "leftEar"],
            ["rightEye", "rightEar"],
            
            // Torso
            ["leftShoulder", "rightShoulder"],
            ["leftShoulder", "leftElbow"],
            ["leftElbow", "leftWrist"],
            ["rightShoulder", "rightElbow"],
            ["rightElbow", "rightWrist"],
            
            // Neck to shoulders
            ["nose", "leftShoulder"],
            ["nose", "rightShoulder"],
            
            // Spine
            ["leftShoulder", "leftHip"],
            ["rightShoulder", "rightHip"],
            ["leftHip", "rightHip"],
            
            // Legs
            ["leftHip", "leftKnee"],
            ["leftKnee", "leftAnkle"],
            ["rightHip", "rightKnee"],
            ["rightKnee", "rightAnkle"]
        ];

        // Colors for different people
        const personColors = [
            { skeleton: "#00FF00", keypoint: "#FF0000" },  // Green/Red
            { skeleton: "#0088FF", keypoint: "#FF8800" },  // Blue/Orange
            { skeleton: "#FF00FF", keypoint: "#FFFF00" },  // Magenta/Yellow
            { skeleton: "#00FFFF", keypoint: "#FF0088" },  // Cyan/Pink
            { skeleton: "#88FF00", keypoint: "#8800FF" }   // Lime/Purple
        ];

        // Load the PoseNet model
        async function loadModel() {
            try {
                status.textContent = "Loading pose detection model...";
                model = await posenet.load({
                    architecture: "MobileNetV1",
                    outputStride: 16,
                    inputResolution: { width: 480, height: 360 },
                    multiplier: 0.75,
                });
                status.textContent = "Model loaded! Click 'Start Camera'";
                startBtn.disabled = false;
                console.log("PoseNet model loaded successfully!");
            } catch (error) {
                status.textContent = "Error loading model: " + error.message;
                console.error(error);
            }
        }

        // Start the webcam
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 480 },
                        height: { ideal: 360 },
                        facingMode: "user"
                    },
                });
                video.srcObject = stream;

                video.addEventListener("loadeddata", () => {
                    // Force canvas to match EXACT video dimensions
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    
                    canvas.width = videoWidth;
                    canvas.height = videoHeight;
                    
                    // Also update the display size
                    video.width = videoWidth;
                    video.height = videoHeight;
                    
                    console.log(`Video dimensions: ${videoWidth}x${videoHeight}`);
                    
                    status.textContent = "âœ… Tracking bodies...";
                    startBtn.textContent = "Camera Running";
                    startBtn.disabled = true;
                    detectPose();
                });
            } catch (error) {
                status.textContent = "Error accessing camera: " + error.message;
                console.error(error);
            }
        }

        // Draw a keypoint (body part) with specific color
        function drawKeypoint(keypoint, color) {
            const { y, x, score } = keypoint;
            if (score > 0.5) {  // Increased threshold for better accuracy
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        // Draw skeleton connections for one person with specific color
        function drawSkeleton(keypoints, color) {
            const keypointMap = {};
            keypoints.forEach((keypoint) => {
                keypointMap[keypoint.part] = keypoint;
            });

            connections.forEach(([part1, part2]) => {
                const kp1 = keypointMap[part1];
                const kp2 = keypointMap[part2];

                if (kp1 && kp2 && kp1.score > 0.5 && kp2.score > 0.5) {  // Increased threshold
                    ctx.beginPath();
                    ctx.moveTo(kp1.position.x, kp1.position.y);
                    ctx.lineTo(kp2.position.x, kp2.position.y);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
        }

        // Main pose detection loop
        async function detectPose() {
            if (!model) return;

            isDetecting = true;

            // Estimate multiple poses (up to 5 people)
            const allPoses = await model.estimateMultiplePoses(video, {
                flipHorizontal: false,
                maxDetections: 5,
                scoreThreshold: 0.5,  // Increased from 0.3 to reduce false positives
                nmsRadius: 30  // Increased to better separate people
            });
            
            // Filter out weak detections - require at least 8 keypoints with good confidence
            const poses = allPoses.filter(pose => {
                const goodKeypoints = pose.keypoints.filter(kp => kp.score > 0.5).length;
                return goodKeypoints >= 8;  // At least 8 strong keypoints to be considered a person
            });

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw each person with a different color
            let infoHTML = "";
            
            if (poses.length > 0) {
                infoHTML = `<div style="margin-bottom: 10px;"><strong>Tracking ${poses.length} person(s)</strong></div>`;
                
                poses.forEach((pose, index) => {
                    const colors = personColors[index % personColors.length];
                    
                    // Draw skeleton for this person
                    drawSkeleton(pose.keypoints, colors.skeleton);
                    
                    // Draw keypoints for this person
                    pose.keypoints.forEach((keypoint) => {
                        drawKeypoint(keypoint, colors.keypoint);
                    });
                    
                    // Add info for this person
                    let visibleKeypoints = pose.keypoints.filter((kp) => kp.score > 0.5);  // Increased threshold
                    infoHTML += `<div class="person-info" style="border-color: ${colors.skeleton};">`;
                    infoHTML += `<strong>Person ${index + 1}</strong> (${visibleKeypoints.length} keypoints detected)<br>`;
                    
                    // Group keypoints by category
                    const facePoints = visibleKeypoints.filter(kp => 
                        ['nose', 'leftEye', 'rightEye', 'leftEar', 'rightEar'].includes(kp.part)
                    );
                    const bodyPoints = visibleKeypoints.filter(kp => 
                        !['nose', 'leftEye', 'rightEye', 'leftEar', 'rightEar'].includes(kp.part)
                    );
                    
                    if (facePoints.length > 0) {
                        infoHTML += '<div style="margin: 5px 0;"><em>Face:</em> ';
                        facePoints.forEach((keypoint) => {
                            const confidence = (keypoint.score * 100).toFixed(0);
                            infoHTML += `<span class="keypoint-info">${keypoint.part}: ${confidence}%</span>`;
                        });
                        infoHTML += '</div>';
                    }
                    
                    if (bodyPoints.length > 0) {
                        infoHTML += '<div style="margin: 5px 0;"><em>Body:</em> ';
                        bodyPoints.forEach((keypoint) => {
                            const confidence = (keypoint.score * 100).toFixed(0);
                            infoHTML += `<span class="keypoint-info">${keypoint.part}: ${confidence}%</span>`;
                        });
                        infoHTML += '</div>';
                    }
                    
                    infoHTML += `</div>`;
                });
            } else {
                infoHTML = "<div>No people detected - step into frame!</div>";
            }

            keypointList.innerHTML = infoHTML;

            // Continue detection loop
            if (isDetecting) {
                requestAnimationFrame(detectPose);
            }
        }

        // Event listeners
        startBtn.addEventListener("click", startCamera);

        // Load model when page loads
        loadModel();
    </script>
</body>
</html>
